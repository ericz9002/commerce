{%extends "auctions/layout.html"%}
{%load static%}
{% load custom_filters %}
{% block extra_links %}
    <link href="{% static 'auctions/listings.css' %}"  rel="stylesheet">
    <link href="{% static 'auctions/comments.css' %}" rel="stylesheet">
    <script>
        //script for adding comments
        document.addEventListener('DOMContentLoaded', ()=>{
            function sleep(ms) {
                const start = Date.now();
                while (Date.now() - start < ms) {
                    // Busy-waiting: Blocks execution
                }
            }

            const comment_input = document.querySelector('#comment-input');
            const form = document.querySelector('#comment-form');
            const csrf_token = document.querySelector('#comment-form input[name="csrfmiddlewaretoken"]').value;
            const listing_str = '{{serialized_listing|escapejs}}';
            console.log(`listing_str is typeof ${typeof listing_str}`);
            console.log(`listing_str is ${listing_str}`);
            const listing = JSON.parse(listing_str);
            console.log(`listing.title is ${listing.title}`);
            console.log(`listing is typeof ${typeof listing}`);
            console.log(`listing is ${listing}`);
            console.log(listing);
            form.addEventListener('submit', (event)=>{
                event.preventDefault();
                console.log('submitted form');
                const request = new Request("{%url 'add_comment' %}", {
                    method: "POST",
                    headers: {'X-CSRFToken': csrf_token},
                    body: JSON.stringify({"comment": comment_input.value, "listing":listing}),
                });
                console.log(`submitting {comment: ${comment_input.value}, csrfmiddlewaretoken: ${csrf_token}}, listing: ${listing}}`);
                fetch(request)
                    .then((response) =>{
                        console.log(response)
                        return response.text()
                    })
                    .then(data =>  {
                        console.log('in then2');
                        console.log("data is", data);
                        const comments_list = document.querySelector('#comments');
                        const new_comment = document.createElement('li');
                        new_comment.innerHTML = data;
                        const delete_icon = new_comment.querySelector(".delete-comment, .icon");
                        console.log("delete_icon is", delete_icon);
                        comments_list.appendChild(new_comment);
                        delete_icon.addEventListener("click", (event)=>{
                            const csrf_token = delete_icon.previousElementSibling.value;
                            const id = delete_icon.parentElement.parentElement.id.slice(8)
                            const request = new Request("{%url 'delete_comment' %}", {
                                method: "DELETE",
                                headers: {'X-CSRFToken': csrf_token},
                                body: JSON.stringify({"comment_id": id})
                            });
                            fetch(request)
                            .then((response) => {return response.json()})
                            .then((data)=>{
                                console.log(data);
                                console.log(typeof(data));
                                console.log(`#comment-${data["comment_id"]}`)
                                document.querySelector(`#comment-${data["comment_id"]}`).parentElement.remove();
                                console.log(data);
                            })
                        })
                    })
                    .catch(error => {
                        console.log('in catch');
                        console.log(`Error: ${error}`);
                    })
                console.log('after fetch');      
            });



            comment_input.addEventListener('keydown', (event)=>{
                if(event.key === 'Enter'){
                    event.preventDefault();
                    console.log('something');
                    form.requestSubmit();
                    form.reset();
                    comment_input.blur();
                }
            })
        })
    </script>
    <script>
        //script for deleting comments
        document.addEventListener('DOMContentLoaded', ()=>{
            console.log("loaded second delete comment script");
            document.querySelectorAll(".delete-comment").forEach((delete_icon)=>{
                delete_icon.addEventListener("click", (event)=>{
                    const csrf_token = delete_icon.previousElementSibling.value;
                    const id = delete_icon.parentElement.parentElement.id.slice(8)
                    const request = new Request("{%url 'delete_comment' %}", {
                        method: "DELETE",
                        headers: {'X-CSRFToken': csrf_token},
                        body: JSON.stringify({"comment_id": id})
                    });
                    fetch(request)
                    .then((response) => {return response.json()})
                    .then((data)=>{
                        console.log(data);
                        console.log(typeof(data));
                        console.log(`#comment-${data["comment_id"]}`)
                        document.querySelector(`#comment-${data["comment_id"]}`).parentElement.remove();
                        console.log(data);
                    })
                })
            })
        })
    </script>
{% endblock %}

{% block body %}

{% include "auctions/listing-layout.html" with listing=listing link=False%}

<hr>
<ol id='comments'>
    {% for comment in comments %}
        <li>
            {% include "auctions/comment-layout.html" with comment=comment user=user %}
        </li>
    {% endfor %}
</ol>

<form id = 'comment-form'>
    {% csrf_token %}
    {% for field in CommentForm %}
        {{field}}
    {% endfor %}
</form>
{%endblock%}